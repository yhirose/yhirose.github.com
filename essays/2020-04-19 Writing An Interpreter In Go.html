<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>"Writing An Interpreter In Go"</title>
</head>
<body>
  <h1>"Writing An Interpreter In Go"</h1>
  <p>2020年4月19日</p>
  <p>遅ればせながら、良書と評判の「<a href="https://www.oreilly.co.jp/books/9784873118222/">Go言語で作るインタープリタ</a>」を買った。この本では学習にちょうどよいサイズのMonkeyという小さなインタープリタ言語を作成する。といっても高階関数も定義でき、なかなか洒落たコードもかける。</p>
  <p>さらっと全体を眺めてみると、平易なコードとわかりやすい説明でしたためられている。無味乾燥な教科書調ではなく、筆者が直接語りかけてくれているような親しみやすさも感じる。それなりに深い内容を扱っているにも関わらず、すんなりと読み進めていける。</p>
  <p>といっても自分でも手を動かさない限り、この本の真価は実感できないだろう。それで実際にMonkeyインタープリタを実装してみることにした。</p>
  <p>Goで書かれたコードを書き写すだけでは、単に手を動かしているに過ぎない。それで使い慣れているC++で実装することにする。本書の字句解析・構文解析器の章は本当に素晴らしいのだが、ここは楽をしてcpp-peglibを使ってAST生成までを任せる。またREPLの実装にもcpp-linenoiseを使用。</p>
  <p>基本的に書かれている通りの順序で進め、「テストコードを移植し、機能を実装し、テストが通るのを確認し、次のセクションに進む」をひたすら繰り返す。</p>
  <p>セクションを終えるごとに訪れる「テストが通るのを見る快さ」が、最後までやり遂げる力となった。また言語が成長するにつれMonleyの表現力が増していくのを見るのも、モチベーションの維持に役立った。</p>
  <p>この本ではとりわけTDDを推奨している。徐々に増えていくテストケースが後に大きなセーフネットへと成長し、バグの早期発見と、安心してコードを書き進めるための心の拠り所となった。リグレッションに即座に気づくため、相当時間の節約につながったと感じる。</p>
  <p>GoのコードをC++に書き換える「移植」という作業は、目に入るコードを忠実に書き写すいわゆる「写経」と異なり、思考力をフル稼働させることを強制される。まずGoのコードが何をしているのかをきちんと把握し、言語間の差異を意識しつつC++に変換していかなければならない。</p>
  <p>構文（変数定義、条件判断、関数定義・呼び出し、構造体の定義）や型（真偽、整数）、データ構造（配列、辞書）、基本的なライブラリ（IO、文字列操作）といった基本的な点についてはどちらも似たようなもの。しかしGoとC++で、類似のコンセプトを異なる仕方で実現している部分もあった。例えば、</p>
  <ul>
    <li>戻り値：複数戻り値 vs 単一戻り値（タプルを使用できるが…）</li>
    <li>遠い関数呼び出し元への通知：戻り値をひたすら伝播 vs 例外送出で一気に通知</li>
    <li>メモリ管理：ガーベッジコレクション vs std::shared_ptrによるリファレンスカウンティング</li>
    <li>差分機能の実装：inteface vs 仮想関数</li>
  </ul>
  <p>このように、必ずしも単純な置き換え作業とはならない箇所が出てくる。まずはGoのコードを理解し、できる限りC++でも同様のスタイルで書けるように努力する。両言語の差異が大きい場合は、C++の特性を反映したコードに変換していく。</p>
  <p>C++でどう書くのが最善かを考える際、言語に対する曖昧な理解では正しい判断を下せない。このことは、GoとC++のそれぞれの言語仕様をより明確に比較・理解する良い機会ともなった。またそれぞれの言語設計者の思想の違いを感じ取れるのも、コード移植のメリットかもしれない。</p>
  <p>それなりのページ数のある本ではあるが、一度「テストコードを移植し、機能を実装し、テストが通るのを確認し、次のセクションに進む」のイテレーションに慣れると、後はそのリズムの繰り返しで、無理なく本の最後のHashとputsの実装までたどり着けた。</p>
  <p>実際に手を動かすことによって、「Go言語で作るインタープリタ」は本当に良く書けた本だと肌で感じることができた。少しずつ部品を実装して積み重ねていく過程は、子供の頃にプラモデルを作っている時の経験と似ている。それはとても楽しいエンターテイメントの時間だった。(<a href="https://github.com/yhirose/monkey-cpp">github.com/yhirose/monkey-cpp</a>)</p>
</body>
